
@{
	ViewBag.Title = "Generar Financiamiento";
	Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">

	<div class="col-xs-12 col-sm-6 col-lg-4 ">
		<label class="control-label" for="cliente">CLIENTE</label>
		<div class="form-group " id="dvcliente">
			<div class="input-group">
				<label class="input-group-addon" for="cliente"><i class="glyphicon glyphicon-user"></i></label>
				@*<input type="text" class="form-control widtTotal" placeholder="Cliente" id="cliente">*@
				<select class="form-control widtTotal" id="cliente"></select>
				<span id="spancliente" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="Fiador">FIADOR</label>
		<div class="form-group" id="dvFiador">
			<div class="input-group">
				<label class="input-group-addon" for="Fiador"><i class="glyphicon glyphicon-user"></i></label>
				@*<input type="text" class="form-control widtTotal" placeholder="Fiador" id="Fiador">*@
				<select class="form-control widtTotal" id="Fiador"></select>
				<span id="spanFiador" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="Promotor">PROMOTOR</label>
		<div class="form-group" id="dvPromotor">
			<div class="input-group">
				<label class="input-group-addon" for="Promotor"><i class="glyphicon glyphicon-user"></i></label>
				@*<input type="text" class="form-control widtTotal" placeholder="Promotor" id="Promotor">*@
				<select class="form-control widtTotal" id="Promotor"></select>
				<span id="spanPromotor" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	@*</div>*@


	@*<div class="row">*@

	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="tipofin">TIPO FINANCIAMIENTO</label>
		<div class="form-group" id="dvtipofin">
			<div class="input-group">
				<label class="input-group-addon" for="tipofin"><i class="glyphicon glyphicon-th-list"></i></label>
				<select class="form-control widtTotal" id="tipofin"></select>
				@*<input type="text" class="form-control widtTotal" placeholder="Tipo financiamiento" id="tipofin">*@
				<span id="spantipofin" class="glyphicon form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="Monto">MONTO</label>
		<div class="form-group" id="dvMonto">
			<div class="input-group">
				<label class="input-group-addon" for="Monto"><i class="glyphicon glyphicon-usd"></i></label>
				<input type="text" class="form-control widtTotal number numberDecimal" placeholder="Monto" id="Monto">
				<span id="spanMonto" class="glyphicon form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="Fecha">FECHA</label>
		<div class="form-group" id="dvFecha">
			<div class="input-group">
				<label class="input-group-addon" for="Fecha"><i class="glyphicon glyphicon-calendar"></i></label>
				<input type="text" class="form-control widtTotal date" placeholder="Fecha" id="Fecha">
				<span id="spanFecha" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	@*</div>*@

	@*<div class="row">*@

	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="frpago">FORMA DE PAGO</label>
		<div class="form-group" id="dvfrpago">
			<div class="input-group">
				<label class="input-group-addon" for="frpago"><i class="glyphicon glyphicon-credit-card"></i></label>
				<select class="form-control widtTotal" id="frpago"></select>
				@*<input type="text" class="form-control widtTotal" placeholder="Forma de pago" id="frpago">*@
				<span id="spanfrpago" class="glyphicon form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="tipoin">TIPO INTERES</label>
		<div class="form-group" id="dvtipoin">
			<div class="input-group">
				<label class="input-group-addon" for="tipoin"><i class="glyphicon glyphicon-th-list"></i></label>
				<select class="form-control widtTotal" id="tipoin"></select>
				@*<input type="text" class="form-control widtTotal" placeholder="Tipo interes" id="tipoin">*@
				<span id="spantipoin" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="porIn">PORCIENTO INTERES</label>
		<div class="form-group" id="dvporIn">
			<div class="input-group">
				<label class="input-group-addon" for="porIn">%</label>
				<input type="text" class="form-control widtTotal number numberDecimal" placeholder="porciento interes" id="porIn">
				<span id="spanporIn" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	@*</div>*@

	@*<div class="row">*@

	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="cuno">CUOTAS NORMALES</label>
		<div class="form-group" id="dvcuno">
			<div class="input-group">
				<label class="input-group-addon" for="cuno">N</label>
				<input type="text" class="form-control widtTotal number" placeholder="Cuotas normales" id="cuno">
				<span id="spancuno" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="feven">FECHA VENCIMIENTO 1RA CUOTA</label>
		<div class="form-group" id="dvfeven">
			<div class="input-group">
				<label class="input-group-addon" for="feven"><i class="glyphicon glyphicon-calendar"></i></label>
				<input type="text" class="form-control widtTotal date" placeholder="Fecha vencimiento" id="feven">
				<span id="spanfeven" class="glyphicon  form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-sm-6 col-lg-4">
		<label class="control-label" for="cuad">CUOTAS ADICCIONALES</label>
		<div class="form-group" id="dvcuad">
			<div class="input-group">
				<label class="input-group-addon" for="cuad"><i class="glyphicon glyphicon-font"></i></label>
				<input type="text" class="form-control widtTotal number disabled" disabled placeholder="Cuotas adiccionales" id="cuad">
				<span id="spancuad" class="glyphicon form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>
</div>

<div class="row">

	<div class="col-xs-12">
		<label class="control-label" for="garantia">GARANTIA</label>
		<div class="form-group" id="dvgarantia">
			<input type="text" class="form-control widtTotal notValidate" style="max-width: 3000px !important;" placeholder="Garantia" id="garantia">
			@*<div class="input-group">
				@*<label class="input-group-addon" for="garantia"><i class="glyphicon glyphicon-check"></i></label>

					<span id="spangarantia" class="glyphicon form-control-feedback" aria-hidden="true"></span>
				</div>*@
		</div>
	</div>

</div>

<div class="row">

	<div class="col-xs-12">
		<label class="control-label" for="observacion">OBSERVACION</label>
		<div class="form-group" id="dvobservacion">
			<div class="input-group">
				<label class="input-group-addon" for="observacion"><i class="glyphicon glyphicon-text-size"></i></label>
				@*<input type="text" class="form-control widtTotal" multiple placeholder="Observacion" id="observacion">*@
				<textarea name="Text1" class="form-control widtTotal notValidate" placeholder="Observacion" id="observacion" rows="3"></textarea>
				<span id="spanobservacion" class="glyphicon form-control-feedback" aria-hidden="true"></span>
			</div>
		</div>
	</div>

</div>

<div class="row">
	<div class="col-xs-12 col-md-3">
		<button class="btn btn-pink btn-block" id="btn-genAmortiza">Generar tabla de amortización</button>
	</div>

	<div class="col-xs-12 col-md-3 pull-right">
		<button class="btn btn-success btn-block" id="btn-activarPrestamo">Activar préstamo</button>
	</div>
	<div class="col-xs-12 col-md-2 pull-right">
		<button id="btn-limpiar" class="btn btn-warning btn-block" onclick="document.location.reload();"><span class="glyphicon glyphicon-trash"></span> Limpiar</button>
	</div>
</div>
	<br />
	<div class="row" style="background-color:#fff7e1;">
		<div class="col-xs-6 col-md-6">
			<label class="control-label">TABLA DE AMORTIZACION</label>
		</div>

		<div class="col-xs-6 col-md-6  text-right">
			<label class="control-label">FINACIAMIENTO @ViewBag.FINACIAMIENTOLast</label>
		</div>
	</div>

	<div class="row" style="background-color:#fff7e1;">
		<div class="table-responsive">
			<table class="table table-condensed  table-hover" id="tbl-fin">
				<thead>
					<tr>
						<th class="text-center">Cuota</th>
						<th class="text-center">Fecha</th>
						<th class="text-center">Monto</th>
						<th class="text-center">Capital</th>
						<th class="text-center">Interes</th>
						<th class="text-center">Balance</th>
						<th class="text-center">Tipo de cuota</th>
					</tr>
				</thead>
				<tbody style="background-color:white;">
					<tr>
						<td class="text-right"></td>
						<td class="text-right"></td>
						<td class="text-right"></td>
						<td class="text-right"></td>
						<td class="text-right"></td>
						<td class="text-center"><b id="total-balance"></b></td>
						<td class="text-right"></td>
					</tr>


				</tbody>
				<tfoot>
					<tr>

						<td class="text-center"></td>
						<td class="text-center"><label id="lbl-total"></label></td>
						<td class="text-center"><b id="total-monto"></b></td>
						<td class="text-center"><b id="total-capital"></b></td>
						<td class="text-center"><b id="total-interes"></b></td>
						<td class="text-center"><b></b></td>
						<td class="text-center"></td>
					</tr>
				</tfoot>
			</table>
		</div>

	</div>


	<!--------------------------------------- Modal para ingresar cuotas adiccionales ----------------------------------------------->
	<div class="modal fade" id="cuoataADModal" tabindex="-1" data-backdrop="static" data-keyboard="false" role="dialog" aria-labelledby="myModalLabel">

		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header bg-warning">
					<button type="button" class="close btn-cerrar btn-cerrarPopup" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Cuotas adiccionales</h4>
				</div>
				<div class="modal-body" id="CuContainer">
					<div class="table-responsive">
						<table class="table table-condensed" id="tbl-cuotasAdicionales">
							<thead>
								<tr>
									<th class="text-center">
										Fecha
									</th>

									<th class="text-center">Capital</th>
									<th class="text-center">Interes</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-success pull-left" id="btn-Guardar">Aplicar</button>
					<button type="button" class="btn btn-danger pull-right btn-cancelar btn-cerrarPopup">Cancelar</button>

				</div>
			</div>
		</div>
	</div>
	@section scripts {


		<script type="text/javascript">
	var dataCuotasAdicionales = [];
	var ListDataFinan = [];
	var dates_allowed = [];

	async function MensajecantidadCuota() {
			const { value: cantidad } = await Swal.fire({
				title: 'Cantidad cuotas',
				input: 'number',
				inputPlaceholder: 'ingrese Cantidad cuotas',
				showCancelButton: true,
				inputValidator: (cantidad) => {
					if (!cantidad || cantidad < 1 || cantidad > 5) {
						return 'Debe ingresar una cantidad entre 1 y 5'
					}
				}
			})

			if (cantidad) {
				$("#cuad").val(cantidad);
				$("#cuad").trigger("change");
			}
		}

	function  mensajeCuotas()
		{
			swal.fire({
				position: 'center',
				icon: "warning",
				title: "Desea incluir cuotas adiccionales ?",
				showCancelButton: true,
				confirmButtonColor: '#f0ad4e',
				confirmButtonText: 'SI'

			}).then((result) => {
				if (result.isConfirmed)
					MensajecantidadCuota();
				 else
					generarAmortizacion();


			});
		}

	function ActivarPrestamo() {
		var currentinput = $("#Fecha").val().split("-");
		var currentDay = currentinput[0];
		var currentMonth = monthNumber(currentinput[1]);
		var currentYear = currentinput[2];
		var currentDate = new Date(currentYear, currentMonth - 1, currentDay);
		var cliente = $("#cliente").val();
		var fiador = $("#Fiador").val();
		var promotor = $("#Promotor").val();

		console.log($("#cliente").val());
		var url = "@Url.Action("activarPrestamo", "Financiamientos")";
		$.ajax({
			type: "POST",
			url: url,
			data: {
				json: JSON.stringify({ ListFinanciamientos: ListDataFinan })
				, fecha: currentDate.toISOString()
				, clienteID: cliente
				, fiadorID: fiador
				, promotorID: promotor
			},
			dataType: "json",
			success: function (_data) {
				MessageNotification(_data.Message, _data.Is_Success, _data.Is_Success);

			}
		});
	}

		function generarAmortizacion(isCuotaAdicional = false) {
			//$('#tbl-fin > tbody .tr').empty();

				var monto = $("#Monto").val();
				var currentinput = $("#feven").val().split("-");
			var currentDay = currentinput[0];
			var currentMonth = monthNumber(currentinput[1]);
			var currentYear = currentinput[2];
			var currentDate = new Date(currentYear, currentMonth - 1, currentDay);
			var ID_tipo = $("#tipoin").val();
			var tipo_cuota = "ADICIONAL";

			dataCuotasAdicionales = [];
			ListDataFinan = [];

			var _Cliente = $("#cliente").val()
				, _Fiador = $("#Fiador").val()
				, _Promotor = $("#Promotor").val()
				, _TipoFin = $("#tipofin").val()
				, _Monto = $("#Monto").val()
				, _Fecha = $("#Fecha").val()
				, _FormaPago = $("#frpago").val()
				, _TipoInteres = $("#tipoin").val()
				, _PorInt = $("#porIn").val()
				, _CuotasNormales = $("#cuno").val()
				, _FechaVencimiento = currentDate
				, _CuotasAdiccionales = $("#cuad").val()
				, _Garantia = $("#garantia").val()
				, _Observacion = $("#observacion").val()
				//, total_balance = 0
				, total_capital = 0
				, total_monto = 0
				, total_interes = 0
				, message = "", strDatos = "";

			if (isCuotaAdicional) {
				dataCuotasAdicionales = [];
				$("#tbl-cuotasAdicionales tbody tr").each(function (index) {

					var string_fecha = $(this).find("#fecha-" + index).val();
					var string_capital = $(this).find("#Capital-" + index).val().replace(',','');
					var string_interes = $(this).find("#interes-" + index).val().replace(',', '');

					var splits = string_fecha.split("-");
					var currentDay2 = splits[0];
					var currentMonth2 = monthNumber(splits[1]);
					var currentYear2 = splits[2];
					var currentDate2 = new Date(currentYear2, currentMonth2 - 1, currentDay2);
					if (ID_tipo == "6") { tipo_cuota = "NORMAL" }

					var json = {
						Fecha: string_fecha,
						capital: string_capital,
						interes: string_interes,
						FechaVencimiento: currentDate2,
						TipoCuota: tipo_cuota,
						TipoInteres: _TipoInteres

					}


					AddItemArray2(index + 1, dataCuotasAdicionales, json);

				});

			} else {
				$("#cuad").val("0");
			}


				strDatos = JSON.stringify({
					numCuota: 0, Cliente: _Cliente
					, Fiador: _Fiador, Promotor: _Promotor
					, TipoFin: _TipoFin, Monto: _Monto
					, Fecha: _Fecha, FormaPago: _FormaPago
					, TipoInteres: _TipoInteres, PorInt: _PorInt
					, CuotasNormales: _CuotasNormales
					, FechaVencimiento: _FechaVencimiento
					, CuotasAdiccionales: _CuotasAdiccionales
					, Garantia: _Garantia, Observacion: _Observacion
					, listCuotasAdiccionales: dataCuotasAdicionales

				});


				// Llenar Tabla amortizacion

			var url = "@Url.Action("CalcularAmortizacion", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					data: {
						json: strDatos
					},
					dataType: "json",
					success: function (_data) {
						var tipoCuota = "";
						$('#tbl-fin  > tbody .tr ').remove();

						if (_data.message.Is_Success == false)
							MessageNotification(_data.message.Message, false);


						_data.ListFinanciamientos.forEach(function (index, key)
						{
							tipoCuota = index.TipoCuota;

								$('#tbl-fin > tbody').append(`'<tr class="tr">
									<td class="text-center">` + index.numCuota  + `</td>
									<td class= "text-center">` + index.Fecha + ` </td>
									<td class="text-center">` + number_format_js(index.Monto, 2, 0) + `</td>
									<td class="text-center">` + number_format_js(index.capital, 2, 0)  + `</td>
									<td class="text-center">` + number_format_js(index.interes, 2, 0) + `</td>
									<td class="text-center">` + number_format_js(index.Balance,2,0) + `</td>
									<td class="text-center">` + tipoCuota + `</td></tr>'`);
							//total_balance += index.Balance;
							total_monto += index.Monto;
							total_capital += index.capital;
							total_interes += index.interes;




						});
						//total_balance = number_format_js(total_balance, 2, 0);
						total_monto = number_format_js(total_monto, 2, 0);
						total_capital = number_format_js(total_capital, 2, 0);
						total_interes = number_format_js(total_interes, 2, 0);


						$("#total-balance").text(total_capital);
						$("#total-monto").text(total_monto);
						$("#total-capital").text(total_capital);
						$("#total-interes").text(total_interes);
						$("#lbl-total").val("Total");
						ListDataFinan = _data.ListFinanciamientos;

					}
				});

		}
		// Activar fechas de las cuotas adiccionales
		function habilitarFechasAdicionales(date, is_adiccional = true)
		{

			if (is_adiccional == false) {
				return [true, 'good_date', 'This date is selectable'];
			}

			// prepend values lower than 10 with 0
			function addZero(no) {
				if (no < 10) {
					return "0" + no;
				} else {
					return no;
				}
			}

			var date_str = [
				addZero(date.getFullYear()),
				addZero(date.getMonth() + 1),
				addZero(date.getDate())
			].join('-');
			if (dates_allowed.find(element => element === date_str)) {

				return [true, 'good_date', 'This date is selectable'];
			} else {
				return [false, 'bad_date', 'This date is NOT selectable'];
			}
		}

		// Validar solo las fechas necesarias en un datePicker
		function validarFechasAdiccionales(date,is_adiccional = true) {



			if (dates_allowed.length == 0) {

				var url = "@Url.Action("FechasCuotas", "Financiamientos")";
				var cuotasNormales = $("#cuno").val();
				var currentinput2 = $("#feven").val().split("-");
				var formaPago = $("#frpago").val();
			var currentDay2 = currentinput2[0];
			var currentMonth2 = monthNumber(currentinput2[1]);
			var currentYear2 = currentinput2[2];
			var currentDate2 = new Date(currentYear2, currentMonth2 - 1, currentDay2);

			$.ajax({
				type: "GET",
				url: url,
				data: {
					cuotasNormales: cuotasNormales
					, FechaVencimiento: currentDate2.toISOString()
					, FormaPago: formaPago

				},
				dataType: "json",
				success: function (_data) {
					dates_allowed = _data;
				}
			});

			}

		}

		$(document).ready(function () {
			var date = new Date();
			var dateToday = date.getDate() + "-" + monthName(date.getMonth() ) + "-" + date.getFullYear();
			$(".date").val(dateToday);

			$("#promotor").val("3");
			$("#Promotor").trigger("change");

			$("#tipoin").selectMania({
				width: '100%',
				size: 'small',
				search: true

			});

			$("#frpago").change(function ()
			{
				dates_allowed = [];
				var inputFechaVen = $("#feven");
				var currentinput2 = $("#Fecha").val().split("-");
				var currentDay2 = currentinput2[0];
				var currentMonth2 = monthNumber(currentinput2[1]);
				var currentYear2 = currentinput2[2];
				var currentDate2 = new Date(currentYear2, currentMonth2 - 1, currentDay2);


			    var date = sumarDias(currentDate2, GetDayOfFormaPago($("#frpago").val()));


				var dateReturn = date.getDate() + "-" + monthName(date.getMonth()) + "-" + date.getFullYear();
				inputFechaVen.val(dateReturn);



			});

			$("#tipofin").selectMania({
				width: '100%',
				size: 'small',
				search: false

			});

			$("#frpago").selectMania({
				width: '100%',
				size: 'small',
				search: true


			});

			$("#cliente").selectMania({
				width: '100%',
				size: 'small',
				search: true
			});

			$("#Fiador").selectMania({
				width: '100%',
				size: 'small',
				search: true
			});

			$("#Promotor").selectMania({
				width: '100%',
				size: 'small',
				search: true
			});

			$("#tbl-fin").DataTable(
				{
					"searching": false,
					"lengthChange": false,
					"paging": false,
					"ordering": false,
					"info": false
				}
			);

			$("#btn-activarPrestamo").click(function () {
				ActivarPrestamo();
			});

			$(".btn-cerrarPopup").click(function () {
				$("#cuad").val(0);
				$("#cuad").trigger("change");
				Show_closeModal('#cuoataADModal', false);

			})

			$("#tipoin").change(function ()
			{
				var ID_tipo = $(this).val();
				var num_cuota = $("#cuno").val()
				if (ID_tipo == "6" && (num_cuota == "" || num_cuota == "0"))
				{
					$("#btn-genAmortiza").attr("disabled", true);
				}
				else if (ID_tipo == "6" && num_cuota != "" && num_cuota != "0") {
					$("#cuad").val(num_cuota);
					$("#cuad").trigger("change");
					$("#cuad").val(0);
					$("#btn-genAmortiza").attr("disabled", true);
					$(".modal-title").text("Cuotas Manuales");
				} else {
					$("#btn-genAmortiza").attr("disabled", false);

				}

			});

			// LLenar los Dropdown al inicio
			iniciollenarDrops();


			$("#cuad").change(function () {

				var isAdiccional = false;
				var tipoin = $("#tipoin").val();

				if (tipoin != "6") {

					isAdiccional = true;
					validarFechasAdiccionales(date, isAdiccional);
				}


				var cantidad = $(this).val();
				$('#tbl-cuotasAdicionales > tbody').empty();
				Show_closeModal("#cuoataADModal", true);
				for (var i = 0; i < cantidad; i++) {
					$('#tbl-cuotasAdicionales > tbody:last-child').append(`'<tr class="tr">
									<td class="text-center"> <input type="text" class="form-control date dateAd"  placeholder="Fecha" id="fecha-`+ i + `"> </td>
									<td class= "text-center"><input type="text" class="form-control  number  notPoint" value=0 placeholder="Capital" id="Capital-`+ i + `"/> </td></td>
									<td class="text-center"><input type="text" class="form-control  number  notPoint" value=0 placeholder="interes" id="interes-`+ i + `"/> </td></td>
									</tr>'`);
				}
				// Anteriormente Estaba con fechaven PARA UNA NUEVA FASE SE IMPLEMENTARA
				var currentinput2 = $("#Fecha").val().split("-"); 
				var currentDay2 = currentinput2[0];
				var currentMonth2 = monthNumber(currentinput2[1]);
				var currentYear2 = currentinput2[2];
				var FechaVencimiento = new Date(currentYear2, currentMonth2 - 1, currentDay2);

				$('.date').datepicker({
					onSelect: function (date, datepicker) {
						ValidarFechas(this, date, datepicker);

					},

					dateFormat: 'dd-mm-yy',
					monthNames: nameMonthComplete(),					
					minDate: FechaVencimiento,		
					// PARA UNA NUEVA FASE SE DESCOMENTARA
					//beforeShowDay: (date) => habilitarFechasAdicionales(date, isAdiccional)//validarFechasAdiccionales(date, isAdiccional)

				});


				$("input").blur(function () {

					validarNumero(this);

				});


			});

			$("#btn-Guardar").click(function () {
				var error = false, message = "";
				var total = 0
					, monto_totalFinanciar = $("#Monto").val().replace(",", '')
					, tipoin = $("#tipoin").val();

				$("#tbl-cuotasAdicionales tbody tr").each(function (index) {
					if (index == 0 ) {
						total = 0;
					}
					var string_fecha = $(this).find("#fecha-" + index).val();
					var string_capital = $(this).find("#Capital-" + index).val();
					var string_interes = $(this).find("#interes-" + index).val();


					if (string_fecha == "" || string_capital == "" || string_interes == "")
					{
						error = true;
						message = "Debe rellenar todos los campos";
						//MessageNotification("Debe rellenar todos los campos", false);
						//return;
					} else if (string_capital + string_interes == 0)
					{
						error = true;
						message = "Los montos capital o interes deben contener valores";
					}
					total = total + parseInt(string_capital.replace(",",''));
				});

				if (error) {
					MessageNotification(message, false);
					return;
				}


				if (total != monto_totalFinanciar && tipoin == "6") // Solo Manual
				{
					MessageNotification("El monto debe ser igual al total del monto a financiar", false);
					return;
				} else if (total > monto_totalFinanciar) // Cuotas adiccionales
				{
					MessageNotification("El monto debe ser menor al total del monto a financiar", false);
					return;
				}

				generarAmortizacion(true);
				Show_closeModal("#cuoataADModal", false);
			});

			$("#btn-genAmortiza").click(function () {
				if ($("#cuad").val() == "") {
					$("#cuad").val(0);
					$("#cuad").trigger("change");
				}
				if (($("#tipofin").val() == 0)) {

					MessageNotification("Debe introducir tipo de financiamiento", false);
					return;
				}
				else if ($("#Monto").val() == "" || $("#Monto").val() == "0") {
					$("#Monto").blur();
					MessageNotification("Debe introducir un monto", false);
					return;
				}
				else if (($("#Fecha").val() == "")) {
					$("#Fecha").blur();
					MessageNotification("Debe introducir fecha financiamiento", false);
					return;
				}
				else if (($("#frpago").val() == 0)) {
					MessageNotification("Debe introducir forma de pago", false);
					return;
				}
				else if (($("#tipoin").val() == 0)) {
					MessageNotification("Debe introducir tipo de financiamiento", false);
					return;
				}
				else if (($("#porIn").val() == 0)) {
					$("#porIn").blur();
					MessageNotification("Debe introducir porciento interes", false);
					return;
				}
				else if (($("#cuno").val() == 0)) {
					$("#cuno").blur();
					MessageNotification("Debe introducir cuotas normales", false);
					return;
				}
				else if (($("#feven").val() == 0)) {
					$("#feven").blur();
					MessageNotification("Debe introducir fecha vencimiento 1ra cuota", false);
					return;
				}

				mensajeCuotas();
				$(".swal2-cancel").text("NO");
				$(".swal2-cancel").focus();

			});

			$('#Fecha,#feven').datepicker({
				onSelect: function (date, datepicker) {
					ValidarFechas(this,date, datepicker);

				},
				dateFormat: 'dd-mm-yy',
				monthNames: nameMonthComplete()



			});



			$("select").blur(function () {
				var currentinput = $(this);
				var inputLenth = currentinput.val();
				var currentDiv = $("#dv" + currentinput.attr("id"));
				var currentSpan = $("#span" + currentinput.attr("id"));

				if (inputLenth == 0) {

					currentDiv.removeClass("has-correct");
					currentDiv.addClass("has-incorrect");

				} else {
					currentDiv.removeClass("has-incorrect");
					currentDiv.addClass("has-correct");
				}

			});
			$("input").blur(function () {

				validarNumero(this);
				var cuno = $(this).attr("id");
				if (cuno == "cuno") {
					$("#tipoin").trigger("change");
				}

			});

			$("input:text").keydown(function (event) {
				if (event.keyCode == 13) {
					enterAsTab();
					event.preventDefault();
					return false;

				}
			});





			function iniciollenarDrops() {

				//$("#tipofin").trigger("change");

				$("#cuad").val("0");

				// Llenar Tipo interes

					  var url = "@Url.Action("GetTypeINT", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					dataType: "json",
					success: function (_data) {

						llenarDropdows(_data, 'tipoin', "Tipo interes");


					}
				});

				// Llenar Tipo Financiamiento

					 url = "@Url.Action("GetTypeFin", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					dataType: "json",
					success: function (_data) {
						llenarDropdows(_data, 'tipofin', "Tipo financiamiento",false);

					}
				});

				// Llenar Tipo Forma de pago

					url = "@Url.Action("GetFormaPago", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					dataType: "json",
					success: function (_data) {
						llenarDropdows(_data, 'frpago', "Tipo forma pago");

					}
				});

				// Llenar Clientes

					url = "@Url.Action("GetCLientes", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					dataType: "json",
					success: function (_data) {
						llenarDropdows(_data, 'cliente',"cliente");
					}
				});

				// Llenar fiadores

					url = "@Url.Action("GetFiadores", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					dataType: "json",
					success: function (_data) {
						llenarDropdows(_data, 'Fiador',"Tipo fiador");
					}
				});

				// Llenar promotores

					url = "@Url.Action("GetPromotores", "Financiamientos")";
				$.ajax({
					type: "GET",
					url: url,
					dataType: "json",
					success: function (_data) {
						llenarDropdows(_data, 'Promotor',"Tipo promotor");
					}
				});


			}
		});


		</script>
	}
